<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nexus Salon — Tickets</title>
  <meta name="description" content="Nexus Salon — Sistema de tickets sincronizado con Firebase.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Nexus Salon" />
  <link rel="apple-touch-icon" href="assets/logo.png" />

  <link rel="icon" type="image/png" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=10" />
</head>
<body>

  <!-- ============== PANTALLA AUTH (GOOGLE) ============== -->
  <div id="authScreen" class="view view-centered">
    <div class="card card-auth">
      <div class="brand-header">
        <div class="brand-logo-wrap">
          <img src="assets/logo.png" alt="Logo" class="brand-logo" />
        </div>
        <div class="brand-text-wrap">
          <h1>Nexus Salon</h1>
          <p>Conecta con Google para sincronizar en Firebase</p>
        </div>
      </div>

      <button id="googleSignInBtn" class="btn btn-google">Conectar con Google</button>

      <p class="msg-info small mt-4">
        *Esta conexión es para acceder a la base de datos (Firestore). Luego entrarás con tu <strong>Nombre + PIN</strong>.
      </p>
    </div>
  </div>

  <!-- ============== LOGIN INTERNO (ADMIN/EMPLEADO) ============== -->
  <div id="pinScreen" class="view view-centered hidden">
    <div class="card card-pin">
      <div class="brand-header">
        <div class="brand-logo-wrap">
          <img id="pinLogo" src="assets/logo.png" alt="Logo" class="brand-logo">
        </div>
        <div class="brand-text-wrap">
          <h1 id="pinAppName">Nexus Salon</h1>
          <p>Acceso por usuario (Nombre + PIN)</p>
        </div>
      </div>

      <div class="grid-2">
        <div class="field-group">
          <label class="field-label" for="loginName">Nombre</label>
          <input id="loginName" type="text" class="field-input" placeholder="Ej. Cynthia" autocomplete="off" />
        </div>
        <div class="field-group">
          <label class="field-label" for="loginPin">PIN</label>
          <input id="loginPin" type="password" maxlength="6" class="field-input" placeholder="****" autocomplete="off" />
        </div>
      </div>

      <p id="pinError" class="msg-error"></p>

      <div class="form-actions">
        <button id="pinEnterBtn" class="btn btn-primary">Entrar</button>
        <button id="logoutBtnLogin" class="btn btn-secondary">Desconectar Google</button>
      </div>

      <p class="msg-info small mt-4">
        Admin ve todo. Empleados solo ven sus tickets.
      </p>
    </div>
  </div>

  <!-- ============== APP PRINCIPAL (MÓVIL 100%) ============== -->
  <div id="appShell" class="view hidden">

    <!-- Topbar (móvil) -->
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand-inline">
          <div class="brand-logo-wrap small">
            <img id="appLogo" src="assets/logo.png" alt="Nexus Salon" class="brand-logo">
          </div>
          <div class="brand-text-wrap">
            <div class="app-name-row">
              <span id="appNameEditable" contenteditable="true" class="app-name">Nexus Salon</span>
            </div>
            <small id="roleBadge" class="app-subtitle">—</small>
          </div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="user-info">
          <span id="userEmail" class="user-email">Sin conexión</span>
        </div>
        <div class="topbar-actions">
          <button id="logoutBtn" class="btn btn-danger">Salir</button>
        </div>
      </div>
    </header>

    <!-- Bottom Nav (móvil) -->
    <nav class="bottom-nav" id="bottomNav">
      <button data-page="dashboard" class="nav-btn nav-btn-active">Ticket</button>
      <button data-page="historial" class="nav-btn">Historial</button>
      <button data-page="caja" class="nav-btn nav-admin">Caja</button>
      <button data-page="comisiones" class="nav-btn nav-admin">Comisiones</button>
      <button data-page="propinas" class="nav-btn nav-admin">Propinas</button>
      <button data-page="retenciones" class="nav-btn nav-admin">Retenciones</button>
      <button data-page="config" class="nav-btn nav-admin">Config</button>
    </nav>

    <main class="layout-main">

      <!-- ====== PAGE: DASHBOARD ====== -->
      <section id="page-dashboard" class="page active-page">
        <div class="panel wide">
          <h2>Nuevo ticket</h2>

          <div class="grid-2">
            <div class="field-group">
              <label class="field-label">Número de ticket</label>
              <input id="ticketNumber" type="text" class="field-input" readonly />
            </div>
            <div class="field-group">
              <label class="field-label">Fecha</label>
              <input id="ticketDate" type="date" class="field-input" />
            </div>
          </div>

          <div class="field-group">
            <label class="field-label">Nombre del cliente</label>
            <input id="clientName" type="text" class="field-input" placeholder="Ej. Marta González" />
          </div>

          <div class="grid-2">
            <div class="field-group">
              <label class="field-label">Técnica</label>
              <select id="technician" class="field-input">
                <option value="">Seleccionar...</option>
              </select>
              <input id="technicianCustom" type="text" class="field-input mt-4" placeholder="Otra técnica (admin opcional)" />
              <p class="msg-info small">*Empleados no pueden cambiar de técnica.</p>
            </div>

            <div class="field-group">
              <label class="field-label">Método de pago</label>
              <select id="paymentMethod" class="field-input">
                <option value="">Seleccionar...</option>
                <option value="ATH Móvil">ATH Móvil</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
              </select>
            </div>
          </div>

          <div class="grid-3">
            <div class="field-group">
              <label class="field-label">Servicio</label>
              <input id="serviceDesc" type="text" class="field-input" placeholder="Corte, tinte, blower, etc." />
            </div>
            <div class="field-group">
              <label class="field-label">Cantidad</label>
              <input id="quantity" type="number" min="1" step="1" class="field-input" value="1" />
            </div>
            <div class="field-group">
              <label class="field-label">Costo por servicio</label>
              <input id="unitPrice" type="number" min="0" step="0.01" class="field-input" placeholder="0.00" />
            </div>
          </div>

          <div class="grid-2">
            <div class="field-group">
              <label class="field-label">Propina</label>
              <input id="tipAmount" type="number" min="0" step="0.01" class="field-input" placeholder="0.00" />
            </div>
            <div class="field-group">
              <label class="field-label">Total (incluye propina)</label>
              <input id="totalAmount" type="number" class="field-input" readonly />
              <p class="msg-info small">Comisión se calcula SIN propina.</p>
            </div>
          </div>

          <div class="form-actions">
            <button id="newTicketBtn" class="btn btn-secondary">Nuevo</button>
            <button id="saveTicketBtn" class="btn btn-primary">Guardar</button>
          </div>

          <p id="formMessage" class="msg-info"></p>
        </div>
      </section>

      <!-- ====== PAGE: HISTORIAL ====== -->
      <section id="page-historial" class="page">
        <div class="panel wide">
          <div class="panel-header">
            <h2>Historial</h2>
            <div class="panel-header-actions">
              <button id="exportPdfBtn" class="btn btn-outline">PDF</button>
              <button id="backupJsonBtn" class="btn btn-outline">JSON</button>
            </div>
          </div>

          <div class="filters-row">
            <div class="filter-group">
              <label>Desde</label>
              <input id="filterStart" type="date" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input id="filterEnd" type="date" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Técnica</label>
              <select id="filterTech" class="field-input small">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="applyFilterBtn" class="btn btn-small btn-primary">Filtrar</button>
              <button id="clearFilterBtn" class="btn btn-small btn-text">Limpiar</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Técnica</th>
                  <th>Servicio</th>
                  <th>Método</th>
                  <th>Total</th>
                  <th>Propina</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="ticketsTableBody"></tbody>
            </table>
          </div>

          <p class="msg-info small">*Empleados solo ven sus tickets.</p>
        </div>
      </section>

      <!-- ====== PAGE: CAJA (ADMIN) ====== -->
      <section id="page-caja" class="page">
        <div class="panel wide">
          <h2>Caja</h2>

          <div class="filters-row">
            <div class="filter-group">
              <label>Desde</label>
              <input id="cajaStart" type="date" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input id="cajaEnd" type="date" class="field-input small">
            </div>
            <div class="filter-group filter-actions">
              <button id="cajaApplyBtn" class="btn btn-small btn-primary">Aplicar</button>
              <button id="cajaClearBtn" class="btn btn-small btn-text">Hoy</button>
            </div>
          </div>

          <div class="caja-summary-grid">
            <div class="caja-card cash">
              <h3>Efectivo</h3>
              <p id="cajaTotalCash" class="caja-amount">$0.00</p>
            </div>
            <div class="caja-card">
              <h3>ATH Móvil</h3>
              <p id="cajaTotalAth" class="caja-amount">$0.00</p>
            </div>
            <div class="caja-card">
              <h3>Tarjeta</h3>
              <p id="cajaTotalCard" class="caja-amount">$0.00</p>
            </div>
            <div class="caja-card total">
              <h3>Total</h3>
              <p id="cajaTotalAll" class="caja-amount">$0.00</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== PAGE: COMISIONES (ADMIN) ====== -->
      <section id="page-comisiones" class="page">
        <div class="panel wide">
          <div class="panel-header">
            <h2>Comisiones</h2>
            <p class="panel-subtitle">Comisión se calcula sobre ventas SIN propinas.</p>
          </div>

          <div class="filters-row">
            <div class="filter-group">
              <label>Desde</label>
              <input type="date" id="comiStart" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input type="date" id="comiEnd" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Técnica</label>
              <select id="comiTech" class="field-input small">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="comiApplyBtn" class="btn btn-small btn-primary">Aplicar</button>
              <button id="comiClearBtn" class="btn btn-small btn-text">Limpiar</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Técnica</th>
                  <th>%</th>
                  <th>Ventas (sin propina)</th>
                  <th>Comisión</th>
                </tr>
              </thead>
              <tbody id="comiTableBody"></tbody>
            </table>
          </div>

          <div class="caja-summary-grid">
            <div class="caja-card total">
              <h3>Total comisión</h3>
              <p id="comiTotal" class="caja-amount">$0.00</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== PAGE: PROPINAS (ADMIN) ====== -->
      <section id="page-propinas" class="page">
        <div class="panel wide">
          <div class="panel-header">
            <h2>Propinas</h2>
            <p class="panel-subtitle">Propinas NO se usan para comisión.</p>
          </div>

          <div class="filters-row">
            <div class="filter-group">
              <label>Desde</label>
              <input type="date" id="tipStart" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input type="date" id="tipEnd" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Agrupar</label>
              <select id="tipGroupBy" class="field-input small">
                <option value="tech">Por técnica</option>
                <option value="day">Por día</option>
                <option value="week">Por semana</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="tipApplyBtn" class="btn btn-small btn-primary">Aplicar</button>
              <button id="tipClearBtn" class="btn btn-small btn-text">Limpiar</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Grupo</th>
                  <th>Propinas</th>
                </tr>
              </thead>
              <tbody id="tipsTableBody"></tbody>
            </table>
          </div>

          <div class="caja-summary-grid">
            <div class="caja-card total">
              <h3>Total propinas</h3>
              <p id="tipsTotal" class="caja-amount">$0.00</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== PAGE: RETENCIONES (ADMIN) ====== -->
      <section id="page-retenciones" class="page">
        <div class="panel wide">
          <div class="panel-header">
            <h2>Retenciones Hacienda (10%)</h2>
            <p class="panel-subtitle">
              Se calcula: <strong>(ventas sin propina - comisión) * 10%</strong>.
            </p>
          </div>

          <div class="filters-row">
            <div class="filter-group">
              <label>Desde</label>
              <input type="date" id="retStart" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input type="date" id="retEnd" class="field-input small">
            </div>
            <div class="filter-group">
              <label>Técnica</label>
              <select id="retTech" class="field-input small">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="retApplyBtn" class="btn btn-small btn-primary">Aplicar</button>
              <button id="retClearBtn" class="btn btn-small btn-text">Limpiar</button>
            </div>
          </div>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Técnica</th>
                  <th>Ventas (sin propina)</th>
                  <th>Comisión</th>
                  <th>Base neta</th>
                  <th>Retención 10%</th>
                  <th>Neto a pagar</th>
                </tr>
              </thead>
              <tbody id="retTableBody"></tbody>
            </table>
          </div>

          <div class="caja-summary-grid">
            <div class="caja-card total">
              <h3>Total retenciones</h3>
              <p id="retTotal" class="caja-amount">$0.00</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ====== PAGE: CONFIG (ADMIN) ====== -->
      <section id="page-config" class="page">
        <div class="panel wide">
          <h2>Configuración</h2>

          <div class="grid-2">
            <div class="field-group">
              <label class="field-label">URL del logo</label>
              <input id="logoUrlInput" type="text" class="field-input" placeholder="https://...logo.png" />
              <button id="saveBrandingBtn" class="btn btn-outline mt-4">Guardar</button>
              <p id="brandingStatus" class="msg-info small"></p>
            </div>

            <div class="field-group">
              <label class="field-label">Texto header PDF</label>
              <textarea id="pdfHeaderText" rows="4" class="field-input"></textarea>
            </div>
          </div>

          <div class="field-group">
            <label class="field-label">Texto footer PDF</label>
            <textarea id="pdfFooterText" rows="3" class="field-input"></textarea>
          </div>

          <div class="field-group">
            <label class="field-label">Texto footer app</label>
            <input id="footerTextInput" type="text" class="field-input" value="© 2025 Nexus Salon — Sistema de tickets" />
          </div>

          <hr class="sep" />

          <h3>Técnicas (CRUD)</h3>
          <p class="msg-info small">Aquí controlas técnicas y su % de comisión.</p>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>% Comisión</th>
                  <th>Activa</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="techTableBody"></tbody>
            </table>
          </div>

          <div class="grid-3 mt-4">
            <div class="field-group">
              <label class="field-label">Nombre técnica</label>
              <input id="techNameInput" type="text" class="field-input" placeholder="Ej. Cynthia" />
            </div>
            <div class="field-group">
              <label class="field-label">% Comisión</label>
              <input id="techPercentInput" type="number" min="0" max="100" step="0.1" class="field-input" placeholder="40" />
            </div>
            <div class="field-group">
              <label class="field-label">&nbsp;</label>
              <div class="form-actions">
                <button id="techSaveBtn" class="btn btn-primary">Guardar</button>
                <button id="techCancelBtn" class="btn btn-secondary">Cancelar</button>
              </div>
            </div>
          </div>

          <hr class="sep" />

          <h3>Usuarios empleados (CRUD)</h3>
          <p class="msg-info small">Admin crea PIN y asigna a qué técnica pertenece el empleado.</p>

          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Rol</th>
                  <th>Técnica</th>
                  <th>Activo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="usersTableBody"></tbody>
            </table>
          </div>

          <div class="grid-3 mt-4">
            <div class="field-group">
              <label class="field-label">Nombre</label>
              <input id="userNameInput" type="text" class="field-input" placeholder="Ej. Carmen" />
            </div>
            <div class="field-group">
              <label class="field-label">PIN</label>
              <input id="userPinInput" type="password" maxlength="6" class="field-input" placeholder="1234" />
            </div>
            <div class="field-group">
              <label class="field-label">Técnica</label>
              <select id="userTechSelect" class="field-input">
                <option value="">Seleccionar...</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button id="userCreateBtn" class="btn btn-primary">Crear empleado</button>
            <button id="userCreateAdminBtn" class="btn btn-outline">Crear admin</button>
          </div>

          <p id="adminNote" class="msg-info small"></p>
        </div>
      </section>

    </main>

    <footer class="footer">
      <span id="footerText">© 2025 Nexus Salon — Sistema de tickets</span>
    </footer>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <script src="app.js?v=10"></script>
</body>
</html>
